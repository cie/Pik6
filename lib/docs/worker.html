<!DOCTYPE html>  <html> <head>   <title>worker.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               worker.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The <strong>Worker</strong> is responsible for synchronizing the presentation state between windows. Each
presentation instance (presentation window or presenter) connects to the worker and exchanges
JS objects describing the presentation's state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The worker caches a copy of the presentation state. Its properties are:</p>

<ul>
<li><code>initialized</code>: True once the worker has been initialized by a presentation instance</li>
<li><code>slide</code>: Current slide number</li>
<li><code>file</code>: Path to the current presentation</li>
<li><code>hide</code>: True if the presentation is hidden at the moment</li>
<li><code>working</code>: True if PIK6 is loading something</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">cached_state</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">initialized</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">slide</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nx">file</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
	<span class="nx">hide</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
	<span class="nx">working</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The list of connected presentation instances.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>When a presentation instance connects, push it to the client list, add the event listener for incoming message
and post the cached state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">self</span><span class="p">.</span><span class="nx">onconnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
	<span class="nx">port</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">handleIncomingState</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">port</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">cached_state</span><span class="p">.</span><span class="nx">initialized</span><span class="p">){</span>
		<span class="nx">cached_state</span><span class="p">.</span><span class="nx">initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nx">port</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">cached_state</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Process an incoming state from one of the presentation instances. Merge the incoming state with the current state
and, if there was any new information, broadcast the result to all connected presentations except the specified port.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">handleIncomingState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">evt</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">incoming_state</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
	<span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">incoming_state</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
		<span class="nx">cached_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">incoming_state</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
	<span class="p">});</span>
	<span class="nx">broadcastCurrentState</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Broadcast the cached state to all presentation instances except the specified port.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">broadcastCurrentState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">port</span><span class="p">){</span>
	<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">port</span><span class="p">){</span>
			<span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">cached_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 