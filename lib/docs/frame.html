<!DOCTYPE html>  <html> <head>   <title>frame.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="controls.html">                 controls.js               </a>                                           <a class="source" href="frame.html">                 frame.js               </a>                                           <a class="source" href="pik.html">                 pik.js               </a>                                           <a class="source" href="presentation.html">                 presentation.js               </a>                                           <a class="source" href="presenter.html">                 presenter.js               </a>                                           <a class="source" href="print.html">                 print.js               </a>                                           <a class="source" href="worker.html">                 worker.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               frame.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>A <strong>frame</strong> is a presentation instance or a presenter view. It displays a
presentation in one or more iframes and synchronizes it's state with other instances
via a shared worker.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*jshint browser:true, mootools:true */</span>
<span class="cm">/*globals io:true */</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Older Android browsers don't support <code>Object.preventExtensions()</code>, so we "fix" this
problem first.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">preventExtensions</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
	<span class="nb">Object</span><span class="p">.</span><span class="nx">preventExtensions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Expose the pik object for the init function to the outside world</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">pik</span> <span class="o">=</span> <span class="p">{};</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
<span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Does the browser support Shared Web Workers?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">supports_worker</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">SharedWorker</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The worker and remote connection instances that are used to talk to other presentations</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">worker</span><span class="p">,</span> <span class="nx">remote_connection</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Represents the presentation state for the frame.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">local_state</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Iframes and slides</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The iframes contain the presentations. The <code>slides</code> variable contains a reference to
the first iframe's slides array, which is the authoritative source for slide
information. Both variables are populated by the init and re-init functions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">iframes</span><span class="p">,</span> <span class="nx">num_iframes</span><span class="p">,</span> <span class="nx">slides</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The iframes are updated by setting the <code>slide</code> and <code>hide</code> property on their global
<code>pik</code> objects. To make the presenter mode and similar interfaces work, each iframe
after the first recieves a slide number that's increased by 1.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">updateIframes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
	<span class="nx">iframes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">iframe</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">pik</span><span class="p">){</span>
			<span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">pik</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">&#39;slide&#39;</span><span class="p">){</span>
				<span class="nx">value</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Calculate the common path of two urls. Stolen from http://medialize.github.com/URI.js/
by Rodney Rehm</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">commonPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="nx">pos</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">pos</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">b</span><span class="p">[</span><span class="nx">pos</span><span class="p">]){</span>
			<span class="nx">pos</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">){</span>
		<span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">){</span>
		<span class="nx">pos</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span><span class="p">).</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>When a pikFile event fires, update the frame's iframes with the new presentation and
set the current slide to 0</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;pikFile&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">href_frame</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span>
	    <span class="nx">href_presentation_old</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span>
	    <span class="nx">common_path</span> <span class="o">=</span> <span class="nx">commonPath</span><span class="p">(</span><span class="nx">href_frame</span><span class="p">,</span> <span class="nx">href_presentation_old</span><span class="p">),</span>
	    <span class="nx">href_presentation_new</span> <span class="o">=</span> <span class="nx">common_path</span> <span class="o">+</span> <span class="nx">file</span><span class="p">;</span>
	<span class="nx">iframes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">iframe</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">!==</span> <span class="nx">href_presentation_new</span><span class="p">){</span>
			<span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">href_presentation_new</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If there is more than one iframe, this function chains all iframes to the first, making
sure that they all display the same presentation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">chainIframes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">iframes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
		<span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
				<span class="kd">var</span> <span class="nx">location_a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
				    <span class="nx">location_b</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">location_a</span><span class="p">.</span><span class="nx">href</span> <span class="o">!==</span> <span class="nx">location_b</span><span class="p">.</span><span class="nx">href</span><span class="p">){</span>
					<span class="nx">location_b</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">location_a</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Managing state</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>The <code>local_state</code> variable represents the presentation state for the frame. The
properties are:</p>

<ul>
<li><code>initialized</code>: True once the worker has been initialized by a presentation instance</li>
<li><code>file</code>: Path to the current presentation</li>
<li><code>slide</code>: Current slide number</li>
<li><code>hide</code>: True if the presentation is hidden at the moment</li>
</ul>

<p>Changes to the local state automatically trigger the corrosponding events, which in
turn are used to keep the presentation and the UI up to date.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">local_state</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>This reflects the real state values that are only accessible by the
APIs getter and setter methods</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">internal_state</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">initialized</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">file</span><span class="o">:</span> <span class="s1">&#39;start.html&#39;</span><span class="p">,</span>
		<span class="nx">slide</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nx">hide</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>All getters for this object are the same, so we can generate them here.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">createGetter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
		<span class="k">return</span> <span class="kd">function</span><span class="p">(){</span>
			<span class="k">return</span> <span class="nx">internal_state</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
		<span class="p">};</span>
	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Keep a copy of the previous state</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">previous_state</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Create the api to the real state (<code>internal_state</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Fire the <code>pikInitalize</code> event when this value changes from false to true for
the first time.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">initialized</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
			<span class="nx">get</span><span class="o">:</span> <span class="nx">createGetter</span><span class="p">(</span><span class="s1">&#39;initialized&#39;</span><span class="p">),</span>
			<span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
				<span class="nx">previous_state</span><span class="p">.</span><span class="nx">initialized</span> <span class="o">=</span> <span class="nx">internal_state</span><span class="p">.</span><span class="nx">initialized</span><span class="p">;</span>
				<span class="nx">internal_state</span><span class="p">.</span><span class="nx">initialized</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">previous_state</span><span class="p">.</span><span class="nx">initialized</span><span class="p">){</span>
					<span class="nb">window</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;pikInitalize&#39;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Fire the <code>pikFile</code> event when the value changes. Pass the new file as
argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">file</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
			<span class="nx">get</span><span class="o">:</span> <span class="nx">createGetter</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
			<span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the file is actually a directory, shave of the final slash</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">){</span>
					<span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="nx">previous_state</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">internal_state</span><span class="p">.</span><span class="nx">file</span><span class="p">;</span>
				<span class="nx">internal_state</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">previous_state</span><span class="p">.</span><span class="nx">file</span> <span class="o">!=</span> <span class="nx">internal_state</span><span class="p">.</span><span class="nx">file</span><span class="p">){</span>
					<span class="nb">window</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;pikFile&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">internal_state</span><span class="p">.</span><span class="nx">file</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Change the slides, but only if the slide we want to go to actually exists.
Fire the <code>pikSlide</code> event when the value changes. Pass the new slide previous
slide's  numbers as arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">slide</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
			<span class="nx">get</span><span class="o">:</span> <span class="nx">createGetter</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">),</span>
			<span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
				<span class="nx">previous_state</span><span class="p">.</span><span class="nx">slide</span> <span class="o">=</span> <span class="nx">internal_state</span><span class="p">.</span><span class="nx">slide</span><span class="p">;</span>
				<span class="nx">internal_state</span><span class="p">.</span><span class="nx">slide</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
				<span class="nx">updateIframes</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
				<span class="nb">window</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;pikSlide&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">internal_state</span><span class="p">.</span><span class="nx">slide</span><span class="p">,</span>
				                              <span class="nx">previous_state</span><span class="p">.</span><span class="nx">slide</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Fire the <code>pikHide</code> event when the value changes to true and <code>pikShow</code> when
it changes to false.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">hide</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
			<span class="nx">get</span><span class="o">:</span> <span class="nx">createGetter</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">),</span>
			<span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
				<span class="nx">previous_state</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="nx">internal_state</span><span class="p">.</span><span class="nx">hide</span><span class="p">;</span>
				<span class="nx">internal_state</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
				<span class="nx">updateIframes</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">previous_state</span><span class="p">.</span><span class="nx">hide</span> <span class="o">!=</span> <span class="nx">internal_state</span><span class="p">.</span><span class="nx">hide</span><span class="p">){</span>
					<span class="k">if</span><span class="p">(</span><span class="nx">internal_state</span><span class="p">.</span><span class="nx">hide</span><span class="p">){</span>
						<span class="nb">window</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;pikHide&#39;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="nb">window</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;pikShow&#39;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>No accidential extensions to <code>api</code> please</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">Object</span><span class="p">.</span><span class="nx">preventExtensions</span><span class="p">(</span><span class="nx">api</span><span class="p">);</span>
	<span class="k">return</span> <span class="nx">api</span><span class="p">;</span>

<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>When the updateState function is used, changes to the state are made and <em>are sent
to the worker or the remote too!</em> This function should always be used to set state,
except when dealing with updates recieved from the worker or a remote source. The
function expects a state object. If the object contains changes to the local state,
the changes are applied, the woker or the remote is notified and the url is changed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">updateState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">changes_to_state</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">state_changed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
	    <span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;initialized&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">];</span>
	<span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">changes_to_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span>
		   <span class="nx">changes_to_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">local_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]){</span>
			<span class="nx">local_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">changes_to_state</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
			<span class="nx">state_changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">});</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">state_changed</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">supports_worker</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">worker</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
			<span class="nx">postStateToWorker</span><span class="p">();</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Poste an Worker&#39;</span><span class="p">,</span> <span class="nx">getPostableState</span><span class="p">());</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">remote_connection</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
			<span class="nx">postStateToRemote</span><span class="p">();</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Poste an Remote&#39;</span><span class="p">,</span> <span class="nx">getPostableState</span><span class="p">());</span>
		<span class="p">}</span>
		<span class="nx">pushState</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Create a copy of the local_state object for posting the current state to the worker or
the remote. Sendung the state object (and all it's setter and getter magic) directly
causes strange things to happen.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">getPostableState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">post_state</span> <span class="o">=</span> <span class="p">{},</span>
	    <span class="nx">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;initialized&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">];</span>
	<span class="nx">state_keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
		<span class="nx">post_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">local_state</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
	<span class="p">});</span>
	<span class="k">return</span> <span class="nx">post_state</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Update the local state with an incoming state from a worker or a remote.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">handleIncomingState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">incoming_state</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">state_keys</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;initialized&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>If incoming state is initialized, use this state for the presentation</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="nx">incoming_state</span><span class="p">.</span><span class="nx">initialized</span><span class="p">){</span>
		<span class="nx">state_keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
			<span class="nx">local_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">incoming_state</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
		<span class="p">});</span>
		<span class="nx">pushState</span><span class="p">();</span>
	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>If the remote party has not been initialized yet, read the state from the url, set
initialized to true and post back the state</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">else</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">state_from_url</span> <span class="o">=</span> <span class="nx">parseStateUrl</span><span class="p">();</span>
		<span class="nx">state_from_url</span><span class="p">.</span><span class="nx">initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="nx">updateState</span><span class="p">(</span><span class="nx">state_from_url</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>Managing the URL</h2>

<p>The frames URL reflects the presentation's file, slide number and hidden state. It
can be manipulated to trigger changes to the state.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Functions used to build, parse and set the state URL</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">buildStateUrl</span><span class="p">,</span> <span class="nx">pushState</span><span class="p">,</span> <span class="nx">parseStateUrl</span><span class="p">,</span> <span class="nx">updateState</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Build a new url for the browser history. It has the format
<code>"#!/frame_file/presentation/slide_number(/hidden)"</code>, where <code>slide_number</code> is actually
the slide number + 1. Too many people out there start counting at 1...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">buildStateUrl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
	<span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;#!&#39;</span><span class="p">;</span>
	<span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">local_state</span><span class="p">.</span><span class="nx">file</span><span class="p">;</span>
	<span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">local_state</span><span class="p">.</span><span class="nx">slide</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">local_state</span><span class="p">.</span><span class="nx">hide</span><span class="p">){</span>
		<span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;/hide&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Replace the browser url with our new url</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pushState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">buildStateUrl</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Parse a state url and return the state as an object. If there is not state url to be
parsed, return an empty object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">parseStateUrl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">parsed_state</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	    <span class="nx">state_url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;!/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">state_url</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">split_state_url</span> <span class="o">=</span> <span class="nx">state_url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">reverse</span><span class="p">();</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">split_state_url</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>If the last member of the state url is "hidden" , treat it as the
"hidden" parameter</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">split_state_url</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">split_state_url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			   <span class="nx">split_state_url</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;hide&#39;</span><span class="p">){</span>
				<span class="nx">parsed_state</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The next member in the state url after the "hidden" parameter
must be the "slide" parameter. Remember to substract -1 from the
url parameter!</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">split_state_url</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">))){</span>
					<span class="nx">parsed_state</span><span class="p">.</span><span class="nx">slide</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">split_state_url</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Return an empty object if the state url can't be parsed</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">else</span> <span class="k">return</span> <span class="p">{};</span>
			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>If the last member of the state url is a number, treat it as the
"slide" parameter. Also set hide to false. Remember to substract -1
from the url parameter!</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">split_state_url</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">split_state_url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">split_state_url</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">))){</span>
				<span class="nx">parsed_state</span><span class="p">.</span><span class="nx">slide</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">split_state_url</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="nx">parsed_state</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>When we have a slide number and the hidden state, we can concatenate the
rest of the state url and treat it as the file path</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span> <span class="p">{</span>
				<span class="nx">parsed_state</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">split_state_url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Return an empty object if there is no state url</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">{};</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">parsed_state</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>On hash change parse the url and set it as the new state</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">parsed_url</span> <span class="o">=</span> <span class="nx">parseStateUrl</span><span class="p">();</span>
	<span class="nx">updateState</span><span class="p">(</span><span class="nx">parsed_url</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h2>Web Worker</h2>

<p>The web worker keeps the different presentation windows in sync. New states can
be pushed to the worker using the <code>postStateToWorker</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Function used by the rest of the code to push the local state to the worker</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">postStateToWorker</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>The setupWorker function is used to initalize the frame when workers are available</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">setupWorker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pik_base_url</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Connect to the worker using the base url specified in the presentation</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">pik_base_url</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
		<span class="nx">pik_base_url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SharedWorker</span><span class="p">(</span><span class="nx">pik_base_url</span> <span class="o">+</span> <span class="s1">&#39;lib/worker.js&#39;</span><span class="p">,</span> <span class="s1">&#39;Pik6&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>A new incoming state replaces the old local copy of the state. This only happens
for new states that did not come from this presentation instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">incoming_state</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Empfange von Worker&#39;</span><span class="p">,</span> <span class="nx">incoming_state</span><span class="p">);</span>
		<span class="nx">handleIncomingState</span><span class="p">(</span><span class="nx">incoming_state</span><span class="p">);</span>
	<span class="p">};</span>

<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Post the local state to the worker</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">postStateToWorker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nx">worker</span><span class="p">.</span><span class="nx">port</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">getPostableState</span><span class="p">());</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h2>Remote Control</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Add the event listeners to a remote socket</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">addRemoteEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span>
	<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">incoming_state</span><span class="p">){</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Empfange von Remote&#39;</span><span class="p">,</span> <span class="nx">incoming_state</span><span class="p">);</span>
		<span class="nx">handleIncomingState</span><span class="p">(</span><span class="nx">incoming_state</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Post the local state to the remote</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">postStateToRemote</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nx">remote_connection</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">getPostableState</span><span class="p">());</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">openRemoteConnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">remote_address</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Build full urls for talking to Socket.io</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">remote_url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">remote_address</span> <span class="o">+</span> <span class="s1">&#39;:16911&#39;</span><span class="p">,</span>
	    <span class="nx">script_url</span> <span class="o">=</span> <span class="nx">remote_url</span> <span class="o">+</span> <span class="s1">&#39;/socket.io/socket.io.js&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Append the script file</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="p">{</span>
		<span class="nx">src</span><span class="o">:</span> <span class="nx">script_url</span>
	<span class="p">}).</span><span class="nx">inject</span><span class="p">(</span><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Try 10 times to connect to Socket.io periodically</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="nx">connection_timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
		<span class="nx">tries</span><span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>If a connection can be established, terminate the worker and setup the
event listeners for the remotie</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">io</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
			<span class="k">try</span> <span class="p">{</span>
				<span class="nx">remote_connection</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">remote_url</span><span class="p">);</span>
				<span class="nx">clearInterval</span><span class="p">(</span><span class="nx">connection_timer</span><span class="p">);</span>
				<span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Connected to remote &quot;</span> <span class="o">+</span> <span class="nx">remote_url</span><span class="p">);</span>
				<span class="nx">addRemoteEvents</span><span class="p">(</span><span class="nx">remote_connection</span><span class="p">);</span>
			<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>If a connection couldn't be established even with <code>io</code> available, ignore
the problem and try again later</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>If a connection couldn't be established after 10 tries, complain to the user</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tries</span> <span class="o">===</span> <span class="mi">10</span><span class="p">){</span>
			<span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t establish conntection to remote &quot;</span> <span class="o">+</span> <span class="nx">remote_url</span><span class="p">);</span>
			<span class="nx">clearInterval</span><span class="p">(</span><span class="nx">connection_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h2>Initalize</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>The pikInit function triggers the inital state update and sets up the iframes.
If we have worker support, let it take care of the initial state. Otherwise
parse the state url and set the local state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pik</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pik_base_url</span><span class="p">){</span>
	<span class="nx">iframes</span> <span class="o">=</span> <span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
	<span class="nx">num_iframes</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
	<span class="nx">slides</span>  <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">pik</span><span class="p">.</span><span class="nx">slides</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>New title</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">frame_title</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElements</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">);</span>
	<span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="nx">frame_title</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Make sure that the iframes always display the same presentation</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">chainIframes</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Boostrap either via worker or via url</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span><span class="p">(</span><span class="nx">supports_worker</span><span class="p">){</span>
		<span class="nx">setupWorker</span><span class="p">(</span><span class="nx">pik_base_url</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">state_from_url</span> <span class="o">=</span> <span class="nx">parseStateUrl</span><span class="p">();</span>
		<span class="nx">state_from_url</span><span class="p">.</span><span class="nx">initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="nx">updateState</span><span class="p">(</span><span class="nx">state_from_url</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>After init, re-apply all local state variables once. This makes sure iframes, state
and everything else in always in sync.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;pikInitalize&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;initialized&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">];</span>
	<span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
		<span class="nx">local_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">local_state</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h2>Re-initalize</h2>

<p>Re-initialize when a new presentation file is loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>The re-init function
* updates the <code>slides</code> variable with the contents of the new presentation
* sets the new title for the frame
* updates the presentation with it's slide number and hide state
* post the new presentation's url to the worker</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">reInit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>New slide set</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">slides</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">pik</span><span class="p">.</span><span class="nx">slides</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>New title</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">frame_title</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElements</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">);</span>
	<span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="nx">frame_title</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Update state</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">new_state</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Update the state with the new file. The new file's path must be relative to the
frame, so we figure out the new presentation's path and post it to the worker.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">href_frame</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span>
	    <span class="nx">href_presentation</span> <span class="o">=</span> <span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span>
	    <span class="nx">common_path</span> <span class="o">=</span> <span class="nx">commonPath</span><span class="p">(</span><span class="nx">href_frame</span><span class="p">,</span> <span class="nx">href_presentation</span><span class="p">),</span>
	    <span class="nx">file_path</span> <span class="o">=</span> <span class="nx">href_presentation</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">common_path</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
	<span class="nx">new_state</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">file_path</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Set hide to false (after it has been set to true when browsing)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">new_state</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Post update</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">updateState</span><span class="p">(</span><span class="nx">new_state</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Update the iframes, fire the reInitalize event</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">updateIframes</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="nx">local_state</span><span class="p">.</span><span class="nx">slide</span><span class="p">);</span>
	<span class="nx">updateIframes</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">fireEvent</span><span class="p">(</span><span class="s1">&#39;pikReInitalize&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>When the iframes fire load events <em>after</em> init has happened, re-initialize the
presentations. Wait for the last iframe to do so and only re-initalize if the
new document actually is a presentation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;pikInitalize&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nx">iframes</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">pik</span><span class="p">){</span>
			<span class="nx">loaded</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">loaded</span> <span class="o">==</span> <span class="nx">iframes</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
				<span class="nx">reInit</span><span class="p">();</span>
				<span class="nx">loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h2>Presentation Events</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Actions in the presentation are triggered by events that come either from key events
(see <code>controls.js</code>) or are delegated to the frame by one of its iframes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEvents</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Go to slide number <code>slide</code> when <code>pikChangeSlide</code> fires, provided the slide exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;pikChangeSlide&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">slide</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">slides</span><span class="p">[</span><span class="nx">slide</span><span class="p">]){</span>
			<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;slide&#39;</span><span class="o">:</span> <span class="nx">slide</span> <span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Go to the previous slide when <code>pikChangePrev</code> fires, provided the slide exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;pikChangeSlidePrev&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="kd">var</span> <span class="nx">goTo</span> <span class="o">=</span> <span class="p">(</span><span class="nx">local_state</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">local_state</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">slides</span><span class="p">[</span><span class="nx">goTo</span><span class="p">]){</span>
			<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;slide&#39;</span><span class="o">:</span> <span class="nx">goTo</span> <span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Go to the next slide when <code>pikChangeNext</code> fires, provided the slide exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;pikChangeSlideNext&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="kd">var</span> <span class="nx">goTo</span> <span class="o">=</span> <span class="nx">local_state</span><span class="p">[</span><span class="s1">&#39;slide&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">slides</span><span class="p">[</span><span class="nx">goTo</span><span class="p">]){</span>
			<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;slide&#39;</span><span class="o">:</span> <span class="nx">goTo</span> <span class="p">});</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Change to file <code>file</code> when <code>pikChangeFile</code> fires</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;pikChangeFile&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">){</span>
		<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;file&#39;</span><span class="o">:</span> <span class="nx">file</span> <span class="p">});</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Toogle the hidden state when <code>pikChangeHide</code> fires</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="s1">&#39;pikChangeHide&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">local_state</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">]){</span>
			<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;hide&#39;</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
		<span class="p">}</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;hide&#39;</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h2>Presentation API</h2>

<p>Functions on the <code>pik</code> object for use by scripts other than <code>frame.js</code> (eg. script for
the presenter)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Go to a specific slide</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pik</span><span class="p">.</span><span class="nx">goTo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">slide</span><span class="p">){</span>
	<span class="nx">updateState</span><span class="p">({</span> <span class="s1">&#39;slide&#39;</span><span class="o">:</span> <span class="nx">slide</span> <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Get the current slide</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pik</span><span class="p">.</span><span class="nx">getCurrent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="k">return</span> <span class="nx">local_state</span><span class="p">.</span><span class="nx">slide</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <h2>Frame UI</h2>

<p>Handle everything that's related to controls not activated by keypress events.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;domready&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Hide the clone and presenter links if the browser doesn't support shared workers</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">supports_worker</span><span class="p">){</span>
	<span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-clone-presentation&#39;</span><span class="p">).</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>
	<span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-open-presenter&#39;</span><span class="p">).</span><span class="nx">setStyle</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Browsing for presentations resets the current slide. Also activate hide for all
other presentation windows.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-framecontrols-browse&#39;</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nx">updateState</span><span class="p">({</span>
		<span class="s1">&#39;slide&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="s1">&#39;hide&#39;</span><span class="o">:</span> <span class="kc">true</span>
	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Keep the frame count and frame number up to date when slides or presentations change</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">[</span><span class="s1">&#39;pikInitalize&#39;</span><span class="p">,</span> <span class="s1">&#39;pikReInitalize&#39;</span><span class="p">,</span> <span class="s1">&#39;pikSlide&#39;</span><span class="p">].</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
		<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="p">(</span><span class="nx">local_state</span><span class="p">.</span><span class="nx">slide</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; / &#39;</span> <span class="o">+</span> <span class="nx">slides</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
		<span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-framecontrols-slidecount&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Force a reload for all iframes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-framecontrols-reload&#39;</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nx">iframes</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">iframe</span><span class="p">){</span>
		<span class="nx">iframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Open frame content for printing</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-framecontrols-print&#39;</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">iframes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="s1">&#39;#print&#39;</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Cloned windows should inherit the origin's hash</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-clone-presentation&#39;</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
	<span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Open a remote connection</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$$</span><span class="p">(</span><span class="s1">&#39;#Pik-remote&#39;</span><span class="p">).</span><span class="nx">addEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">remote_address</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">prompt</span><span class="p">(</span><span class="s2">&quot;Enter the remote server&#39;s address&quot;</span> <span class="o">+</span>
	                                   <span class="s2">&quot; (without http://, port and trailing slash)&quot;</span><span class="p">);</span>
	<span class="nx">openRemoteConnection</span><span class="p">(</span><span class="nx">remote_address</span><span class="p">);</span>
	<span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">});</span>

<span class="p">});</span>


<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 